# Cache storage for proxied S3 images
proxy_cache_path /var/cache/nginx/cee levels=1:2 keys_zone=cee_cache:10m max_size=1g inactive=7d use_temp_path=off;

server {
  listen 80;
  listen [::]:80;
  server_name cee.photography WWW_cee.photography;
  location ^~ /.well-known/acme-challenge/ { root /var/www/cee/site; default_type "text/plain"; try_files $uri =404; }
  return 301 https://cee.photography$request_uri;
}
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name WWW_cee.photography;
  ssl_certificate /etc/nginx/ssl/cee/fullchain.pem;
  ssl_certificate_key /etc/nginx/ssl/cee/privkey.pem;
  return 301 https://cee.photography$request_uri;
}
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;
  server_name cee.photography;
  root /var/www/cee/site;
  index index.html;
  # SPA fallback
  # Protect management UI with basic auth
  location ^~ /manage {
    auth_basic "Management";
    auth_basic_user_file /etc/nginx/cee.htpasswd;
    try_files $uri /index.html;
  }
  location / { try_files $uri /index.html; }
  # RSS feed
  location = /feed.xml {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://127.0.0.1:9002/feed.xml;
  }
  # Backend routes
  location /photos { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Connection ""; client_max_body_size 50m; proxy_read_timeout 300s; proxy_pass http://127.0.0.1:9002; }
  location = /photos.json { proxy_pass http://127.0.0.1:9002/photos; }
  # Proxied images from S3 via this domain
  location ^~ /images/ {
    proxy_set_header Host japanesebirdcookingspaghetti-assets.s3.us-west-1.amazonaws.com;
    # Do not forward Basic Auth header to S3 (causes 403/400)
    proxy_set_header Authorization "";
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 300s;
    # Caching
    proxy_cache cee_cache;
    proxy_cache_valid 200 301 302 1h;
    proxy_cache_valid 404 5m;
    proxy_hide_header Set-Cookie;
    proxy_ignore_headers Set-Cookie;
    add_header X-Cache $upstream_cache_status;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    # Map /images/<key> -> https://japanesebirdcookingspaghetti-assets.s3.us-west-1.amazonaws.com/<key>
    proxy_pass https://japanesebirdcookingspaghetti-assets.s3.us-west-1.amazonaws.com/;
  }
  ssl_certificate /etc/nginx/ssl/cee/fullchain.pem;
  ssl_certificate_key /etc/nginx/ssl/cee/privkey.pem;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  location ^~ /.well-known/acme-challenge/ { root /var/www/cee/site; default_type "text/plain"; try_files $uri =404; }
}
